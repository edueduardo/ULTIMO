=====================================================================
‚ö†Ô∏è  PROMPT ULTIMO - CO-PARENT SHIELD V100.100 (MAX) ‚ö†Ô∏è
AUDITORIA CARRASCO EXTREMA - IMPLEMENTA√á√ÉO 100% OBRIGAT√ìRIA
=====================================================================

üî• **INSTRU√á√ïES CR√çTICAS ANTES DE COME√áAR:**
1. Leia TODO o conte√∫do 3 vezes antes de codificar
2. Cada etapa deve ser informada com status [EM ANDAMENTO/CONCLU√çDA/ERRO]
3. Em caso de bug, sistema deve alertar em üî¥ VERMELHO o pr√≥ximo passo
4. Ao final de cada corre√ß√£o, lembre em üî¥ ALERTA VERMELHO: "VOLTE AO DETERMINADO NO PROMPT ULTIMO"
5. Responda com an√°lise profissional como se fosse para venda enterprise
6. Implemente 100% - sem desculpas, sem atalhos, sem "futuro"

=====================================================================
CAMADA 1: VIS√ÉO ESTRAT√âGICA BIL√çNGUE (PT/EN)
=====================================================================

[PT-BR] Voc√™ √© ENGENHEIRO(A) FULL-STACK S√äNIOR + PRODUCT DESIGNER + ARQUITETO(A) DE PRODUTO + AUDITOR(A) CARRASCO EXTREMO. 
Sua miss√£o: construir o SaaS **Co-Parent Shield** como o produto definitivo de co-parenting para os pr√≥ximos 10 anos.

[EN] You are a SENIOR FULL-STACK ENGINEER + PRODUCT DESIGNER + PRODUCT ARCHITECT + RUTHLESS EXTREME AUDITOR.
Your mission: build **Co-Parent Shield** as the definitive co-parenting SaaS for the next 10 years.

üéØ **FILOSOFIA DE PRODUTO:**
- Foco em alto conflito com seguran√ßa emocional e jur√≠dica REAL
- Court-friendly DE VERDADE (n√£o simula√ß√£o)
- IA em 3 camadas: LENS (an√°lise) + SHIELD (resposta) + GUIDE (explica√ß√£o)
- B2C + B2B (advogados, terapeutas, times)
- Diferenciais que esmagam concorrentes (OurFamilyWizard, TalkingParents, etc.)

üöÄ **STACK DEFINITIVA 2025-2035:**
- Next.js 14+ (App Router) + TypeScript STRICT
- Supabase (Postgres + Auth + RLS + Storage)
- React + Tailwind + shadcn/ui + Radix
- Stripe (B2C/B2B) + React Query + Zod
- OpenAI + multi-providers + fallback heur√≠stico 100%
- Sentry + OTel + Prometheus + logs sem PII
- Testes completos + k6 + e2e

=====================================================================
CAMADA 2: ARQUITETURA T√âCNICA CARRASCO++
=====================================================================

üìÅ **ESTRUTURA OBRIGAT√ìRIA:**
```
apps/web/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (marketing)/          # Landing, pricing, login, signup
‚îÇ   ‚îú‚îÄ‚îÄ (app)/app/            # Dashboard autenticado
‚îÇ   ‚îî‚îÄ‚îÄ api/                  # TODAS as rotas /api
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts              # Supabase Auth server-side
‚îÇ   ‚îú‚îÄ‚îÄ supabase.ts          # Client admin
‚îÇ   ‚îú‚îÄ‚îÄ crypto/              # Court Pack assinatura
‚îÇ   ‚îú‚îÄ‚îÄ ai/                  # LENS/SHIELD/GUIDE + Judge Loop
‚îÇ   ‚îú‚îÄ‚îÄ plan-limits.ts       # Limites por plano
‚îÇ   ‚îú‚îÄ‚îÄ usage.ts             # Verifica√ß√£o de uso
‚îÇ   ‚îú‚îÄ‚îÄ metrics.ts           # Prometheus
‚îÇ   ‚îî‚îÄ‚îÄ otel.ts              # OpenTelemetry
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ ui/                  # shadcn/ui components
‚îÇ   ‚îî‚îÄ‚îÄ dashboard/           # UI espec√≠ficas
‚îú‚îÄ‚îÄ tests/                   # Unit√°rios
‚îú‚îÄ‚îÄ tests-e2e/              # End-to-end
‚îî‚îÄ‚îÄ load/                   # k6 scripts
supabase/
‚îú‚îÄ‚îÄ migrations/             # SQL schema + RLS
‚îî‚îÄ‚îÄ seed.sql               # Dados iniciais
```

üóÑÔ∏è **SCHEMA COMPLETO (RLS OBRIGAT√ìRIO):**
- `profiles` - Usu√°rios autenticados
- `human_profiles` - Contexto pessoal extra para IA
- `cases` - Casos de co-parenting
- `case_members` - Controle de acesso por caso
- `messages` - Todas as mensagens (inbound/outbound)
- `analyses` - Resultados LENS/SHIELD/GUIDE
- `ai_call_logs` - Logs de chamadas IA
- `subscriptions` - Planos Stripe
- `calendar_events` - Eventos por caso
- `message_receipts` - Confirma√ß√µes de leitura
- `export_verifications` - Court Pack append-only
- `audit_events` - Auditoria append-only
- `notifications` - Centro de notifica√ß√µes
- `emotion_checkins` - Check-ins emocionais

üîê **POL√çTICAS DE SEGURAN√áA:**
- RLS em TODAS as tabelas
- Auth real via getSessionUser() - SEM x-user-id
- Service role APENAS em export/webhook/audit
- CSP headers + Security headers
- Segredos NUNCA no front
- Logs sem PII (conte√∫do de mensagens)

=====================================================================
CAMADA 3: M√ìDULOS OBRIGAT√ìRIOS 100% IMPLEMENTADOS
=====================================================================

ü§ñ **IA CORE (LENS/SHIELD/GUIDE):**
- LENS: risk_score 0-100, labels, summary, semaphore green/yellow/red
- SHIELD: neutral_reply + Judge Loop com m√©tricas
- GUIDE: tip explicativo sem diagn√≥stico/jur√≠dico
- Fallback heur√≠stico completo (FORCE_HEURISTIC=true)
- Multi-provider com estrutura pronta

‚öñÔ∏è **COURT PACK (PROVA FORENSE):**
- Export JSON/PDF com timeline completa
- Manifesto SHA-256 + assinatura ECDSA P-256
- AUTH CODE de 24 hex chars verific√°vel publicamente
- Verificador em /api/verify + p√°gina /landing/verify
- Tabelas append-only (sem UPDATE/DELETE)
- Helpers crypto completos em Node.js

üí∞ **PLANOS E LIMITES:**
- free: 1 caso, 10 msgs/dia, sem court pack
- starter: 3 casos, 50 msgs/dia, court pack + √°udio
- pro: 10 casos, 200 msgs/dia, tudo liberado
- b2b: 50 casos, 1000 msgs/dia, features enterprise
- Verifica√ß√£o em tempo real em toda rota cr√≠tica

üîî **NOTIFICA√á√ïES IN-APP:**
- risk_alert (an√°lises red)
- plan_limit (80% do limite)
- system/onboarding
- Centro completo em /app/notifications
- Badge de n√£o lidas no header

üí≠ **M√ìDULO EMOCIONAL (C√çRCULO):**
- Check-ins di√°rios por caso
- Intensidade 0-10 + emo√ß√£o principal
- Timeline com gr√°fico sparkline
- Integra√ß√£o com radar de risco

üìä **OBSERVABILIDADE COMPLETA:**
- Sentry client + server (sem PII)
- M√©tricas Prometheus em /api/metrics
- OTel spans em toda opera√ß√£o
- Health check em /api/health
- Readiness check em /api/healthz/readiness

=====================================================================
CAMADA 4: ROTAS API OBRIGAT√ìRIAS
=====================================================================

üî• **ROTAS PRINCIPAIS:**
- `POST /api/analyze-message` - An√°lise completa LENS/SHIELD/GUIDE
- `POST /api/message/preflight` - Revis√£o pr√©-envio
- `GET /api/cases/[id]/export` - Court Pack JSON/PDF
- `GET /api/verify` - Verificador p√∫blico
- `GET /api/notifications` - Lista notifica√ß√µes
- `POST /api/notifications/read` - Marcar lidas
- `POST /api/emotions/checkin` - Registrar emo√ß√£o
- `GET /api/emotions/timeline` - Timeline emocional
- `GET /api/usage/summary` - Uso vs limites
- `GET /api/metrics` - M√©tricas Prometheus
- `GET /api/health` - Health check simples
- `GET /api/healthz/readiness` - DB + Redis check

üõ°Ô∏è **MIDDLEWARES:**
- Rate limit por IP (120 req/min)
- Rate limit por caso (20 req/min)
- CSP headers
- Security headers
- Auth check em todas rotas /api

=====================================================================
CAMADA 5: AUDITORIA CARRASCO EXTREMA
=====================================================================

üîç **CHECKLIST OBRIGAT√ìRIO (RESPOSTA EXIGIDA):**

[-1] LEITURA DO PDF CONTEXTO (se existir):
   [ ] PDF lido e entendido como contexto apenas
   [ ] Conflitos resolvidos a favor deste prompt

[0] VIS√ÉO E PRODUTO:
   [ ] Entendido Co-Parent Shield como SaaS definitivo
   [ ] Diferenciais claros vs concorrentes
   [ ] Stack 2025-2035 definida

[1] ESTRUTURA DE PASTAS:
   [ ] apps/web/app/(marketing) criado
   [ ] apps/web/app/(app)/app criado
   [ ] apps/web/lib/ com todos helpers
   [ ] apps/web/components/ com shadcn/ui
   [ ] tests/, tests-e2e/, load/ criados

[2] SUPABASE + SCHEMA:
   [ ] Todas as tabelas criadas com migrations
   [ ] RLS habilitado em TODAS as tabelas
   [ ] Policies por auth.uid() funcionando
   [ ] Fun√ß√µes SQL de limites criadas

[3] AUTENTICA√á√ÉO:
   [ ] getSessionUser() implementado
   [ ] Layout autenticado com redirect
   [ ] Sem uso de x-user-id em rotas

[4] IA CORE:
   [ ] LENS funcionando (heuristic + OpenAI)
   [ ] SHIELD com Judge Loop implementado
   [ ] GUIDE com disclaimers
   [ ] FORCE_HEURISTIC funcionando

[5] COURT PACK:
   [ ] Export JSON com verification completo
   [ ] Export PDF gerando arquivo > 0 bytes
   [ ] Assinatura ECDSA P-256 funcionando
   [ ] AUTH CODE de 24 chars hex
   [ ] /api/verify validando corretamente
   [ ] Tabelas append-only sem UPDATE/DELETE

[6] PLANOS E LIMITES:
   [ ] planLimits.ts com todos planos
   [ ] checkPlanLimits() funcionando
   [ ] Retorno 403 PLAN_LIMIT_REACHED
   [ ] Dashboard com barras de progresso

[7] NOTIFICA√á√ïES:
   [ ] Tabela notifications com RLS
   [ ] GET /api/notifications funcionando
   [ ] POST /api/notifications/read funcionando
   [ ] UI /app/notifications completa
   [ ] Badge n√£o lidas no header

[8] EMOCIONS:
   [ ] Tabela emotion_checkins com RLS
   [ ] POST /api/emotions/checkin funcionando
   [ ] GET /api/emotions/timeline funcionando
   [ ] UI com gr√°fico sparkline

[9] OBSERVABILIDADE:
   [ ] Sentry inicializado client + server
   [ ] M√©tricas em /api/metrics
   [ ] OTel spans nas opera√ß√µes
   [ ] /api/health retornando ok: true
   [ ] /api/healthz/readiness com DB + Redis

[10] RATE LIMIT:
    [ ] Middleware por IP funcionando
    [ ] Rate limit por caso ativo
    [ ] Retorno 429 com Retry-After

[11] TESTES:
    [ ] Unit√°rios para crypto, judge, validators
    [ ] e2e para export + verify
    [ ] k6 script funcionando

[12] BUILD E DEPLOY:
    [ ] npm run typecheck sem erros
    [ ] npm run build sucesso
    [ ] Dockerfile standalone funcional

[13] SEGURAN√áA:
    [ ] Sem segredos no front
    [ ] CSP headers ativos
    [ ] Security headers ativos
    [ ] Logs sem PII

[14] PERFORMANCE:
    [ ] k6 p95 < 500ms
    [ ] Taxa de erro < 1%
    [ ] OTel spans configurados

[15] DOCUMENTA√á√ÉO:
    [ ] openapi.yaml completo
    [ ] .env.example com todas vars
    [ ] README com setup completo

=====================================================================
CAMADA 6: EXECU√á√ÉO E VERIFICA√á√ÉO
=====================================================================

üî• **FLUXO DE EXECU√á√ÉO OBRIGAT√ìRIO:**

1. **SETUP INICIAL:**
   ```bash
   export DATABASE_URL=postgres://user:pass@host:5432/db
   npm install
   npm run db:migrate
   npm run db:seed
   ```

2. **VERIFICA√á√ÉO DE BUILD:**
   ```bash
   npm run typecheck  # deve ser 100% ok
   npm run build      # deve ser 100% ok
   npm test           # todos testes passando
   ```

3. **EXECU√á√ÉO LOCAL:**
   ```bash
   npm run dev
   # Testar: GET /api/health ‚Üí { ok: true }
   ```

4. **TESTE COURT PACK:**
   ```bash
   # Criar caso, exportar JSON, verificar code
   curl "http://localhost:3000/api/cases/{id}/export?format=json"
   curl "http://localhost:3000/api/verify?code=XXXXX"
   ```

5. **TESTE DE CARGA:**
   ```bash
   FORCE_HEURISTIC=true k6 run load/k6-shield-test.js
   ```

=====================================================================
CAMADA 7: PERGUNTA FINAL OBRIGAT√ìRIA
=====================================================================

üö® **RESPONDA EXPLICITAMENTE:**

"VOC√ä IMPLEMENTOU 100% DO PROMPT ULTIMO CO-PARENT SHIELD?
- Se SIM: confirme cada item do checklist [-1 a 15] com [OK]
- Se N√ÉO: liste EXATAMENTE o que falta, POR QUE n√£o implementou, e quais arquivos/rotas precisam ser criados/corrigidos

N√ÉO aceite implementa√ß√µes parciais. N√ÉO adie itens cr√≠ticos. 
Se algo falhar, CORRIJA e REPITA a auditoria at√© 100% OK."

=====================================================================
INSTRU√á√ïES DE USO NO WINDSURF
=====================================================================

1. Copie TODO o conte√∫do deste arquivo
2. Cole como PRIMEIRA mensagem no Windsurf
3. Exija resposta completa do checklist
4. Se algum item estiver [PENDENTE], exija corre√ß√£o imediata
5. N√£o aceite "vou implementar depois" - implemente AGORA

=====================================================================
FIM DO PROMPT ULTIMO - V100.100 (MAX)
=====================================================================

üíÄ **AUDITORIA CARRASCO:** Este prompt √© extremamente detalhado porque
produtos enterprise precisam de implementa√ß√£o 100% sem gaps.
Sem desculpas, sem atalhos, sem "futuro". IMPLEMENTE TUDO AGORA! üíÄ
